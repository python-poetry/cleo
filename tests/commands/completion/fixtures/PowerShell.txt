$_my_function = {
    param(
        [string] $wordToComplete,
        [System.Management.Automation.Language.Ast] $commandAst,
        [int] $cursorPosition
    )

    $options = "--ansi", "--help", "--no-ansi", "--no-interaction", "--quiet", "--verbose", "--version"
    $commands = "command:with:colons", "hello", "help", "list", "spaced command"

    if ($wordToComplete -notlike '--*' -and $wordToComplete -notlike "" -and ($commandAst.CommandElements.Count -eq "2")) {
        return $commands | Where-Object { $_ -like "$wordToComplete*" }
    }

    $result = $commandAst.CommandElements | Select-Object -Skip 1 | Where-Object { $_ -notlike '--*' }
    switch ($result -Join " " ) {
        "command:with:colons" { $options += "--goodbye"; Break; }
        "hello" { $options += "--dangerous-option", "--option-without-description"; Break; }
        "spaced command" { $options += "--goodbye"; Break; }
    }

    return $options | Where-Object { $_ -like "$wordToComplete*" }
}

Register-ArgumentCompleter -Native -CommandName script -ScriptBlock $_my_function
